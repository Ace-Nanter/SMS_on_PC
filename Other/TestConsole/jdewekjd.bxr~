using System;
using System.Text;
using System.Text.RegularExpressions;
using LibUsbDotNet;
using LibUsbDotNet.Main;

namespace TestConsole
{
    internal class ReadWriteEventDriven
    {
        public static DateTime LastDataEventDate = DateTime.Now;
        public static UsbDevice MyUsbDevice;                                                // Device avec lequel on communique

        public static void Main(string[] args)
        {
            int devVersion, reponse = 0;   // Retour d'échanges avec l'appareil
            UsbDeviceFinder MyUsbFinder = new UsbDeviceFinder("YT910PKBQU");      // Numéro de série tel Adrien
            UsbSetupPacket setupPacket;                     // "En-tête" des requêtes
            char[] IObuffer = new char[2];                  // Pour contenir l'API reçue
            string[] hostInformations = new string[6]       // Pour stocker les infos qu'on envoie au téléphone
                {"Gigabyte",                                // Manufacturer
                "MyPC",                                     // Model
                "Adrien_PC",                                // Description
                "1",                                        // Version (???)
                "https://github.com/Ace-Nanter/SMS_on_PC",  // URI
                "Android Open Accessory Protocol" };        // Description du protocole ?

            ErrorCode ec = ErrorCode.None;                  // Code d'erreur, sorte de flag
            
            try
            {
                // Find and open the usb device.
                MyUsbDevice = UsbDevice.OpenUsbDevice(MyUsbFinder);

                // If the device is open and ready
                if (MyUsbDevice == null) throw new Exception("Device Not Found.");



                /*--------------------- Demande de l'API du téléphone ---------------------*/
                setupPacket = new UsbSetupPacket(
                (Byte)0xc0,                // bmRequestType
                (Byte)51,                  // bRequest
                (Int16)0,                  // wValue
                (Int16)0,                  // wIndex
                (Int16)2);                 // wLength

                MyUsbDevice.ControlTransfer(ref setupPacket, (char[])IObuffer, 2, out reponse);       // On demande la version du device
                if(reponse < 0)             // TODO : Exception à mettre en place
                {
                    Console.WriteLine("Problème lors de la demande de la version !");
                }
                devVersion = IObuffer[1] << 8 | IObuffer[0];
                Console.WriteLine("Version de Code du Device : " + devVersion);

                System.Threading.Thread.Sleep(1000);       // On laisse un peu de temps
                /*-----------------------------------------------------------------------------*/
                /*---------------------- Envoi des informations accessory ---------------------*/
                
                int i = 0;

                while(reponse >= 0 && i < hostInformations.Length)
                {
                    setupPacket = new UsbSetupPacket(
                    (Byte)0x40,
                    (Byte)52,
                    (Int16)0,
                    (Int16)i,
                    (Int16)hostInformations[i].Length);

                    MyUsbDevice.ControlTransfer(ref setupPacket,
                        hostInformations[i].ToCharArray(),
                        hostInformations[i].Length,
                        out reponse);

                    i++;
                    Console.WriteLine("Je suis dans le while !");
                }

                if (reponse < 0) Console.WriteLine("Problème lors de la mise en mode host");
                else Console.WriteLine("Envoi de l'identification du PC réussie");

                /*-----------------------------------------------------------------------------*/
                /*---------------------------- Mise en mode accessory -------------------------*/
                setupPacket = new UsbSetupPacket(0x40, 53, 0, 0, 0);
                MyUsbDevice.ControlTransfer(ref setupPacket, null, 0, out reponse);
                if (reponse < 0) Console.WriteLine("Erreur lors de'une étape de connexion");

                Console.WriteLine("Mise du téléphone en mode accessory");
                
                if(MyUsbDevice == null)         // On vérifie que le téléphone est toujours là
                {
                    Console.WriteLine("Eh merde");
                }

                /*-----------------------------------------------------------------------------*/
                Console.WriteLine(MyUsbDevice.ActiveEndpoints.ToString());
                Console.WriteLine("Success bordel !");

                // MyUsbDevice.ControlTransfer(handle, 0x40, 52, 0, 0, (char*)manufacturer, strlen(manufacturer), 0);

                /*if (lenghtTransferred < 2)                 // Tout n'a pas été transféré
                {
                    Console.WriteLine("Problème lors de la demande accessory !");
                }*/

                while(true)
                {
                    Console.WriteLine("Coucou !");
                    System.Threading.Thread.Sleep(10000);
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine();
                Console.WriteLine((ec != ErrorCode.None ? ec + ":" : String.Empty) + ex.Message);
            }
        }
    }
}